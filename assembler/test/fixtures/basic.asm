.ORIG x3000

LDI R0, INPUT   ; a
AND R1, R1, x0  ; counter

LOOP_BODY
; if R0 == 1 then FINISH
AND R2, R2, x0
NOT R2, R2
ADD R2, R0, R2
BRz FINISH

; R1++
ADD R1, R1, x1

; if R0%2 == 0 then EVEN
AND R2, R0, x1
BRz EVEN

; R0 = 3*R0 + 1
ADD R2, R0, R0
ADD R0, R2, R0
ADD R0, R0, x1
BRnzp LOOP_BODY

EVEN ; R0 = R0/2
AND R2, R2, x0
ADD R2, R2, x1
AND R3, R3, x0
ADD R3, R3, x2
AND R4, R4, x0  ; result
NEXT_BIT
AND R5, R0, R3
BRz SKIP_ADD
ADD R4, R4, R2
SKIP_ADD
; Shift R2 and R3
ADD R2, R2, R2
ADD R3, R3, R3
BRz FINISH_DIV
BRnzp NEXT_BIT

FINISH_DIV
ADD R0, R4, x0
BRnzp LOOP_BODY

FINISH
STI R1, OUTPUT

HALT

INPUT  .FILL x3100
OUTPUT .FILL x3101

.END
